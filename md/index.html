<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" initial-scale="1"/>
    <title>Marked in the browser</title>
  <link href="default.css" rel="stylesheet" />
    <link href="github-md.css" rel="stylesheet" />
    <script src="github-md.js"></script>
    <script src="tex-chtml.js"></script>
    <script src="jquery.min.js"></script>
    <script src="jquery.qrcode.min.js"></script>
</head>

<body>
    <div id="header"><div>By 来自东方的访客</div></div>
    <div id="content"></div>
    <div id="footer">
        <div class="qrc">
            <div id="qrcode"></div>
            <div class="md-download"><a href="javascript:d()">点击下载</a></div>
        </div>
    </div>
    <script src="marked.min.js"></script>
    <script>
        let val = "",
        url = "";
        
        if (!val) {
            const tex = location.search;
            if (tex.startsWith('?tex=')) {
                const split = tex.substr(5).split('&d=');
                val = decodeURI(atob(split[0]));
                if (split[1]) {
                    const json = JSON.parse(decodeURI(atob(split[1])));
                    url = json.url;
                    document.querySelector('#header>div').innerText = `By ${json.name}`;
                }
            }
        }
        if (!url) {
            url = "https://bincooo.github.io/vuepress-doc";
        }

        val = val.replaceAll(/([^$]{1})\$([^$]{1,})\$/g, '$$$$$2$$$$');
        document.getElementById('content').innerHTML=marked.parse(val);
        hljs.highlightAll();
        MathJax.typeset();
        let codes = document.querySelectorAll('code');
        codes.forEach(item => {
            let lang = item.classList[0]?.split('-')[1];
            if (lang) {
              item.title = `[lang: ${lang}]`;
            }
        });
        $('#qrcode').qrcode({
            width: 120,
            height: 120,
            background: "#f0f0f0",//背景颜色  
            foreground: "#000000", //前景颜色
            correctLevel :0,//纠错等级 
            text: url
        });

        function download(filename, text) {
          var element = document.createElement('a');
          element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
          element.setAttribute('download', filename);
          element.style.display = 'none';
          document.body.appendChild(element);
          element.click();
          document.body.removeChild(element);
        }

        function d() {
            download('marked.md', val);
        }
        // console.log('https://bincooo.github.com/qrcode?tex=' + btoa(encodeURI(val)))
    </script>
</body>

</html>
